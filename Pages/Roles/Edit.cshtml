@page "{id}"
@model RoleEditModel
@{
    // Usato con asp-for per la creazione di nuovi claim
    EditClaimInputModel inputModel = new();
}
<div class="row">
    <div class="col-10">
        <h1>@ViewData["Title"]</h1>
    </div>
    <div class="col-2 d-flex justify-content-end align-items-end mb-2">
        <form asp-page-handler="Delete">
            <button type="submit" class="btn btn-danger">Elimina</button>
        </form>
    </div>
    <div class="col-12"><a asp-page="/Roles/Index"><small>&#8592; Torna all'elenco</small></a></div>
</div>
<fieldset id="info" class="mt-5">
    <legend>Informazioni</legend>
    <span asp-validation-for="RoleInfo" class="text-danger"></span>
    <partial name="_RoleEditForm" for="RoleInfo"></partial>
    <span asp-validation-for="RoleInfo" class="text-danger"></span>
</fieldset>

<fieldset id="claims" class="mt-5">
    <legend>Claim assegnati al ruolo (@Model.RoleClaims.Count)</legend>
    <p>Qui si possono assegnare al ruolo sia i permessi che altri tipi di claim standard. I permessi supportati sono: @string.Join(", ", Model.PermissionNames).
    <div class="row">
        <div class="col-7"><label asp-for="@inputModel.Type"></label></div>
        <div class="col-3"><label asp-for="@inputModel.Value"></label></div>
        <div class="col-2"></div>
    </div>
    <hr class="mt-0">
    @foreach (Claim claim in Model.RoleClaims)
    {
        <form method="post" asp-page-handler="RevokeClaim" asp-fragment="claims">
            <div class="row">
                <div class="col-7 claim-type">
                    @claim.Type
                    <input type="hidden" name="Type" value="@claim.Type">
                </div>
                <div class="col-3">
                    @claim.Value
                    <input type="hidden" name="Value" value="@claim.Value">
                </div>
                <div class="col-2">
                    <button type="submit" class="btn btn-outline-danger btn-block">Revoca</button>
                </div>
            </div>
        </form>
        <hr>
    }
    <form method="post" asp-page-handler="AssignClaim" asp-fragment="claims">
        <div class="row bg-light pt-2 pb-2">
            <div class="col-7">
                <div class="input-group">
                    <input type="text" id="claim-type" asp-for="@inputModel.Type" class="form-control" placeholder="Digita un claim type o selezionalo dalla lista..." onchange="toggleRoleSelector(this.value)">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Seleziona</button>
                        <div class="dropdown-menu selector" onclick="setValue(event, true);">
                            <a class="dropdown-item" data-value="@nameof(Permission)">@nameof(Permission)</a>
                            <div role="separator" class="dropdown-divider"></div>
                            @foreach (KeyValuePair<string, string> claimType in Model.StandardClaimTypes)
                            {
                            <a class="dropdown-item" data-value="@claimType.Key">@claimType.Value</a>
                            }
                        </div>
                    </div>
                </div>
                <span asp-validation-for="@inputModel.Type" class="text-danger"></span>
            </div>
            <div class="col-3">
                <div class="input-group">
                    <input type="text" id="claim-value" asp-for="@inputModel.Value" class="form-control" placeholder="Claim value...">
                    <div class="input-group-append">
                        <button id="role-selector" class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Seleziona</button>
                        <div class="dropdown-menu" onclick="setValue(event)">
                            @foreach (string permissionName in Enum.GetNames<Permission>())
                            {
                            <a class="dropdown-item" data-value="@permissionName">@permissionName</a>
                            }
                        </div>
                    </div>
                </div>
                <span asp-validation-for="@inputModel.Value" class="text-danger"></span>
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-outline-primary btn-block">Assegna</button>
            </div>
        </div>
    </form>
    <div class="row">
        <div class="col-12">
        <span asp-validation-for="RoleClaims" class="text-danger"></span>
        </div>
    </div>
</fieldset>
@section Scripts
{
    <script>
    function setValue(event, toggle) {
        if (!event.target || !event.target.dataset.value) {
            return;
        }
        $(event.target).closest('.input-group').find("input").val(event.target.dataset.value);
        event.preventDefault();
        if (toggle) {
            toggleRoleSelector(event.target.dataset.value);
        }
    }
    function toggleRoleSelector(value) {
        var roleSelector = $('#role-selector');
        if (value === '@nameof(Permission)') {
            roleSelector.show();
        } else {
            roleSelector.hide();
        }
    }
    toggleRoleSelector($('#claim-type').val());
    </script>
}